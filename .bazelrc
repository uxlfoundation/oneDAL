# Global options

common  

build -c opt \
      --incompatible_enable_cc_toolchain_resolution \
      --incompatible_require_linker_input_cc_api 

# Aliases for user-defined flags
build --flag_alias=backend_config=@config//:backend_config
build --flag_alias=test_link_mode=@config//:test_link_mode
build --flag_alias=test_thread_mode=@config//:test_thread_mode
build --flag_alias=test_external_datasets=@config//:test_external_datasets
build --flag_alias=test_nightly=@config//:test_nightly
build --flag_alias=test_weekly=@config//:test_weekly
build --flag_alias=test_disable_fp64=@config//:test_disable_fp64
build --flag_alias=release_dpc=@config//:release_dpc
build --flag_alias=device=@config//:device
build --flag_alias=cpu=@config//:cpu
build --flag_alias=enable_assert=@config//:enable_assert

# Always pass this env variable to test rules, because SYCL
# OpenCL backend uses it to determine available devices
test --test_env=OCL_ICD_FILENAMES \
     --test_env=SYCL_DEVICE_FILTER

# This variable is needed for MPI
test --test_env=FI_PROVIDER_PATH

# This flag is added for migration to Bazel 9.0.0:
# In Bazel 9.0.0, the strict action environment for tests is enabled by default
# (see https://github.com/bazelbuild/bazel/releases/tag/9.0.0)
# Instead of using --incompatible_strict_action_env, we explicitly pass
# the required environment variable to tests for compatibility:
test --test_env=LD_LIBRARY_PATH

# This variable is used to determine location of datasets for testing
test --test_env=DAAL_DATASETS

# Flag for setting the test timeout to 15 minutes
test --test_timeout=900

# Configuration: 'public'
# Build & run all tests for public interface
build:public \
    --build_tag_filters="-private"

test:public \
    --test_tag_filters="-private"


# Configuration: 'private'
# Build & run all tests for internal functionality
build:private \
    --build_tag_filters="-public"

test:private \
    --test_tag_filters="-public"


# Configuration: 'host'
# Build & run all host tests
build:host \
    --build_tag_filters="host"

test:host \
    --test_tag_filters="host"


# Configuration: 'dpc'
# Build & run all DPC++ tests
build:dpc \
    --build_tag_filters="dpc"

test:dpc \
    --test_tag_filters="dpc"


# Configuration: 'host-public'
# Build & run all host tests for public interface
build:host-public \
    --build_tag_filters="host,-private"

test:host-public \
    --test_tag_filters="host,-private"


# Configuration: 'host-private'
# Build & run all host tests for internal functionality
build:host-private \
    --build_tag_filters="host,-public"

test:host-private \
    --test_tag_filters="host,-public"


# Configuration: 'dpc-public'
# Build & run all DPC++ tests for public interface
build:dpc-public \
    --build_tag_filters="dpc,-private"

test:dpc-public \
    --test_tag_filters="dpc,-private"


# Configuration: 'dpc-private'
# Build & run all DPC++ tests for internal functionality
build:dpc-private \
    --build_tag_filters="dpc,-public"

test:dpc-private \
    --test_tag_filters="dpc,-public"


# Configuration: 'release-dpc'
# Build release artifacts including DPC++ libs.
# The //:release target automatically builds all ISA variants when
# --cpu is unset (auto). Use --cpu=<isa> to restrict for CI speed.
#   bazel build //:release                       # CPU only, all ISAs
#   bazel build //:release --config=release-dpc  # with DPC++ libs
#   bazel build //:release --cpu=avx2            # CI: avx2 only
build:release-dpc \
    --release_dpc=true


# Configuration: 'dev'
# Fast local development build — compiles only for the host machine's
# highest ISA (auto-detected). Use this to speed up iterative builds.
# NOT suitable for release/packaging.
#   bazel build //cpp/oneapi/dal:tests --config=dev
build:dev \
    --cpu=auto


# =============================================================================
# Debug and Sanitizer Configurations
# Equivalent to Make REQDBG / REQSAN options
# =============================================================================

# Configuration: 'dbg'
# Debug build with assertions enabled.
# Equivalent to Make: REQDBG=1
# Adds: -g debug symbols, -DDEBUG_ASSERT, -DONEDAL_ENABLE_ASSERT
#   bazel build //:release --config=dbg
#   bazel test //cpp/oneapi/dal:tests --config=dbg
common:dbg \
    --compilation_mode=dbg \
    --enable_assert=True

# Configuration: 'dbg-symbols'
# Debug symbols only — no assertion checking, no -O0.
# Equivalent to Make: REQDBG=symbols
# Adds -g to the default opt build; preserves -O2/-O3 optimization.
#   bazel build //:release --config=dbg-symbols
common:dbg-symbols \
    --copt=-g \
    --cxxopt=-g


# Configuration: 'asan'
# AddressSanitizer build.
# Equivalent to Make: REQSAN=address
# Note: combine with --config=dbg for best results (Make recommendation).
#   bazel test //cpp/oneapi/dal:tests --config=asan --config=dbg
common:asan \
    --copt=-fsanitize=address \
    --copt=-fno-omit-frame-pointer \
    --linkopt=-fsanitize=address

# Configuration: 'asan-static'
# AddressSanitizer with static libasan linkage.
# Equivalent to Make: REQSAN=static
common:asan-static \
    --copt=-fsanitize=address \
    --copt=-fno-omit-frame-pointer \
    --linkopt=-fsanitize=address \
    --linkopt=-static-libasan


# Configuration: 'tsan'
# ThreadSanitizer build.
# Equivalent to Make: REQSAN=thread
#   bazel test //cpp/oneapi/dal:tests --config=tsan
common:tsan \
    --copt=-fsanitize=thread \
    --copt=-fno-omit-frame-pointer \
    --linkopt=-fsanitize=thread


# Configuration: 'ubsan'
# UndefinedBehaviorSanitizer build.
# Equivalent to Make: REQSAN=undefined
#   bazel test //cpp/oneapi/dal:tests --config=ubsan
common:ubsan \
    --copt=-fsanitize=undefined \
    --copt=-fno-omit-frame-pointer \
    --linkopt=-fsanitize=undefined


# =============================================================================
# Custom flags
# For injecting arbitrary compiler/linker flags (equivalent to Make COPT/CXXFLAGS):
#   bazel build //:release --copt=-march=native
#   bazel build //:release --copt=-O2
#   bazel build //:release --linkopt=-Wl,--as-needed
# Or persist in user-local ~/.bazelrc:
#   build --copt=-your-flag
# =============================================================================

#===============================================================================
# Copyright contributors to the oneDAL project
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#===============================================================================

{% set version = environ.get('GIT_DESCRIBE_TAG', '0.0.0') %}
{% set git_hash = environ.get('GIT_FULL_HASH', 'unknown')[:7] %}
{% set buildnumber = 0 %}

package:
  name: dal-feedstock
  version: {{ version }}

source:
  - path: ..

build:
  skip: true  # [not (linux64 or win)]
  number: {{ buildnumber }}
  string: h{{ git_hash }}_{{ buildnumber }}_{{ cxx_compiler }}
  include_recipe: False
  ignore_run_exports_from:
    - dpcpp_impl_linux-64  # [linux64 or win]
  script_env:
    - REQCPU=avx2  # [linux64 or win]
    - CONDA_CXX_COMPILER=icx  # [ cxx_compiler == "dpcpp" ]
    - CONDA_CXX_COMPILER=clang  # [ cxx_compiler == "clangxx" ]
    - CONDA_CXX_COMPILER=gnu  # [ cxx_compiler == "gxx" ]

requirements:
  build:
    - python
    - make  # [linux]
    - cmake  # [linux64 or win]
    - {{ compiler('cxx') }}
    - dpcpp_impl_linux-64  # [linux64 or win]
    - onedpl-devel  # [linux64 or win]
    - mkl-devel  # [linux64 or win]
    - mkl-static  # [linux64 or win]
    - mkl-devel-dpcpp  # [linux64 or win]
    - onemkl-sycl-include  # [linux64 or win]
  host:
    - tbb-devel

outputs:
  - name: dal
    script: pack.sh  # [linux]
    requirements:
      host:
        - tbb-devel
    test:
      requires:
        - python
        - pytest
        - scikit-learn-intelex =={{ version.split('.')[0] }}.*
        - pandas
        - xgboost
        - lightgbm
        - shap
        - catboost
        - treelite
        - array-api-compat
        - array-api-strict
      commands:
        - test -f $PREFIX/lib/libonedal_core.so.3  # [linux]
        - test -f $PREFIX/lib/libonedal_dpc.so.3  # [linux]
        - test -f $PREFIX/lib/libonedal_thread.so.3  # [linux]
        - pytest --pyargs daal4py --verbose
        - pytest --pyargs onedal --verbose
        - pytest --pyargs sklearnex --verbose
    about:
      summary: oneAPI Data Analytics Library (oneDAL) runtime libraries

  - name: dal-include
    script: pack.sh  # [linux]
    test:
      commands:
        - test -f $PREFIX/include/oneapi/dal.hpp
    about:
      summary: Headers for building against oneAPI Data Analytics Library (oneDAL)

  - name: dal-static
    script: pack.sh  # [linux]
    requirements:
      run:
        - {{ pin_subpackage('dal-include', exact=True) }}
    test:
      commands:
        - test -f $PREFIX/lib/libonedal_core.a  # [linux]
        - test -f $PREFIX/lib/libonedal_dpc.a  # [linux]
        - test -f $PREFIX/lib/libonedal_thread.a  # [linux]
    about:
      summary: Static libraries for oneAPI Data Analytics Library (oneDAL)

  - name: dal-devel
    script: pack.sh  # [linux]
    requirements:
      run:
        - {{ pin_subpackage('dal', exact=True) }}
        - {{ pin_subpackage('dal-include', exact=True) }}
    test:
      commands:
        - test -f $PREFIX/lib/cmake/oneDAL/oneDALConfig.cmake  # [linux]
        - test -f $PREFIX/lib/cmake/oneDAL/oneDALConfigVersion.cmake  # [linux]
        - test -f $PREFIX/lib/pkgconfig/dal-dynamic-threading-host.pc  # [linux]
        - test -f $PREFIX/lib/pkgconfig/dal-static-threading-host.pc  # [linux]
    about:
      summary: Devel package for building against oneAPI Data Analytics Library (oneDAL)

about:
  home: https://uxlfoundation.github.io/oneDAL
  license: Apache-2.0
  license_file:
    - LICENSE
    - third-party-programs.txt
  summary: oneAPI Data Analytics Library (oneDAL)
  description: |
    oneAPI Data Analytics Library (oneDAL) is a C++ and DPC++ library
    (powering the Extension for Scikit-learn in Python) which implements
    accelerated machine learning routines for tabular data
    (e.g. linear regression, K-means clustering, random forests, etc.)
    for CPUs, GPUs, and multi-node distributed setups.
  dev_url: https://github.com/uxlfoundation/oneDAL
  doc_url: https://uxlfoundation.github.io/oneDAL
